<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•èµ„é¡¹ç›®å¤„ç†å·¥å…·</title>
    <!-- æ·»åŠ SheetJSåº“ç”¨äºç”ŸæˆExcelæ–‡ä»¶ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* å…¨å±€æ ·å¼é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        h1 {
            text-align: center;
            color: #2d3748;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .controls {
            margin: 20px 0 30px;
            text-align: center;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        button {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
            min-width: 140px;
        }

        button:hover:not(:disabled) {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(72, 187, 120, 0.4);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        #status {
            margin: 20px 0;
            padding: 12px 16px;
            border-radius: 8px;
            background-color: #f7fafc;
            border-left: 4px solid #48bb78;
            font-size: 14px;
            font-weight: 500;
            color: #4a5568;
            transition: all 0.3s ease;
        }

        .progress-container {
            margin: 20px 0;
            display: none;
            background: #f7fafc;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .progress-bar {
            width: 100%;
            height: 28px;
            background-color: #e2e8f0;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78 0%, #38a169 100%);
            width: 0%;
            transition: width 0.5s ease-in-out;
            border-radius: 14px;
            box-shadow: 0 0 12px rgba(72, 187, 120, 0.5);
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: progressShine 1.5s infinite;
        }

        @keyframes progressShine {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .progress-text {
            margin-top: 10px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #4a5568;
        }

        .progress-percentage {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            z-index: 1;
        }

        .filter-section {
            margin: 30px 0;
            padding: 25px;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .filter-section h3 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-section h3::before {
            content: "ğŸ”";
            font-size: 22px;
        }

        .filter-row {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-row:first-of-type {
            margin-top: 0;
        }

        .filter-row:last-of-type {
            margin-bottom: 0;
        }

        .filter-row label {
            font-size: 14px;
            font-weight: 600;
            color: #4a5568;
            min-width: 120px;
        }

        .filter-row input[type="file"] {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background-color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-row input[type="file"]:hover {
            border-color: #48bb78;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.1);
        }

        .filter-row input[type="number"] {
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            width: 160px;
            font-size: 14px;
            transition: all 0.3s ease;
            background-color: white;
        }

        .filter-row input[type="number"]:focus {
            outline: none;
            border-color: #48bb78;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.1);
        }

        .file-list {
            margin: 30px 0;
            max-height: 350px;
            overflow-y: auto;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background-color: #f7fafc;
            transition: all 0.3s ease;
        }

        .file-item {
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            transition: all 0.2s ease;
            font-size: 14px;
            color: #4a5568;
            cursor: pointer;
        }

        .file-item:hover {
            background-color: #edf2f7;
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item-empty {
            padding: 20px;
            text-align: center;
            color: #a0aec0;
            font-style: italic;
        }

        /* é¡µé¢åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(72, 187, 120, 0.3);
            border-radius: 50%;
            border-top-color: #48bb78;
            animation: spin 1s ease-in-out infinite;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* æˆåŠŸæç¤ºæ ·å¼ */
        .success {
            color: #38a169;
            font-weight: 600;
        }

        /* é”™è¯¯æç¤ºæ ·å¼ */
        .error {
            color: #f56565;
            font-weight: 600;
        }

        /* ä¿¡æ¯æç¤ºæ ·å¼ */
        .info {
            color: #4299e1;
            font-weight: 600;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .file-list::-webkit-scrollbar {
            width: 8px;
        }

        .file-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .file-list::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }

        .file-list::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        /* æŠ•èµ„æ–‡ä»¶æ ¼å¼è¯´æ˜æ ·å¼ */
        .format-guide {
            margin-bottom: 20px;
            padding: 18px;
            background-color: white;
            border: 2px solid #e6fffa;
            border-radius: 10px;
            background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%);
        }

        .format-guide h4 {
            color: #2f855a;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .format-guide h4::before {
            content: "ğŸ“‹";
            font-size: 18px;
        }

        .format-guide p {
            font-size: 14px;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .format-guide ul {
            list-style-type: none;
            padding-left: 0;
            margin-bottom: 15px;
        }

        .format-guide li {
            font-size: 14px;
            color: #4a5568;
            margin-bottom: 8px;
            padding-left: 24px;
            position: relative;
        }

        .format-guide li::before {
            content: "âœ…";
            position: absolute;
            left: 0;
            top: 0;
            color: #48bb78;
        }

        .format-example {
            margin-top: 15px;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .format-example table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .format-example th {
            background-color: #f7fafc;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
        }

        .format-example td {
            padding: 10px;
            color: #4a5568;
            border-bottom: 1px solid #e2e8f0;
        }

        .format-example tr:last-child td {
            border-bottom: none;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .container {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            .controls {
                flex-direction: column;
                align-items: center;
            }

            button {
                width: 100%;
                max-width: 300px;
            }

            .filter-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .filter-row label {
                min-width: auto;
            }

            .filter-row input[type="number"] {
                width: 100%;
            }
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .container {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>æŠ•èµ„é¡¹ç›®å¤„ç†å·¥å…·</h1>
        <div class="controls">
            <button id="selectDir">é€‰æ‹©ç›®å½•</button>
            <button id="processFiles" disabled>å¤åˆ¶æ–‡ä»¶</button>
            <button id="regenerateList" disabled>ç”Ÿæˆåˆ—è¡¨</button>
        </div>
        <div id="status"></div>
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-percentage" id="progressPercentage">0%</div>
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText"></div>
        </div>
        <div class="filter-section">
            <h3>æŒ‰æŠ•èµ„é¢ç­›é€‰æ–‡ä»¶</h3>
            <div class="format-guide">
                <h4>æŠ•èµ„é¢æ–‡ä»¶æ ¼å¼è¦æ±‚</h4>
                <ul>
                    <li>æ–‡ä»¶æ ¼å¼ï¼š.xlsx æˆ– .xls</li>
                    <li>çœ‹ç¤ºä¾‹ğŸ‘‡</li>
                </ul>
                <div class="format-example">
                    <table>
                        <tr>
                            <th>é¡¹ç›®ä»£ç </th>
                            <th>æœ¬æœˆæ–°å¢å»ºå®‰</th>
                            <th>æœ¬æœˆæ–°å¢è®¾å¤‡å·¥å™¨å…·</th>
                            <th>æœ¬æœˆæ–°å¢å…¶ä»–</th>
                        </tr>
                        <tr>
                            <td>MA4F0WYH0420582003</td>
                            <td>5000</td>
                            <td>2000</td>
                            <td>1000</td>
                        </tr>

                    </table>
                </div>
            </div>
            <div class="filter-row">
                <label for="investmentFile">ä¸Šä¼ æŠ•èµ„é¢æ–‡ä»¶ï¼š</label>
                <input type="file" id="investmentFile" accept=".xlsx,.xls">
            </div>
            <div class="filter-row">
                <label>æŠ•èµ„é¢ï¼ˆä¸‡å…ƒï¼‰ï¼š</label>
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <span>â‰¥</span>
                        <input type="number" id="investmentValue" placeholder="è¾“å…¥æ•°å€¼" value="5000"
                            style="padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; width: 120px; font-size: 14px;">
                    </div>
                </div>
            </div>
            <div class="filter-row">
                <button id="filterFiles" disabled>æŒ‰æŠ•èµ„é¢ç­›é€‰</button>
                <button id="generateUnlockFormula" disabled style="margin-left: 10px;">ç”Ÿæˆè§£é”å…¬å¼</button>
            </div>
        </div>
        <div class="file-list" id="fileList"></div>

    </div>

    <script>
        let selectedFiles = [];
        let selectedDirectory = '';
        let rootDirectoryHandle = null;
        let investmentData = new Map(); // å­˜å‚¨é¡¹ç›®ä»£ç åˆ°æŠ•èµ„é¢çš„æ˜ å°„
        let uploadedInvestmentFile = null;

        // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶å¤„ç†
        document.getElementById('investmentFile').addEventListener('change', async (event) => {
            console.log('ğŸ“‹ [æŠ•èµ„é¢ä¸Šä¼ ] === å¼€å§‹ä¸Šä¼ æŠ•èµ„é¢æ–‡ä»¶ ===');
            const file = event.target.files[0];
            if (!file) {
                console.log('âš  æœªé€‰æ‹©æ–‡ä»¶ï¼Œå–æ¶ˆä¸Šä¼ ');
                return;
            }

            console.log('ğŸ“ é€‰æ‹©çš„æ–‡ä»¶ï¼š', file.name, 'ï¼ˆå¤§å°ï¼š', file.size, 'å­—èŠ‚ï¼‰');

            // æ£€æŸ¥æ–‡ä»¶æ ¼å¼
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (fileExtension !== 'xlsx' && fileExtension !== 'xls') {
                console.error('âŒ æ— æ•ˆçš„æ–‡ä»¶æ ¼å¼ï¼š', fileExtension);
                alert('è¯·ä¸Šä¼ xlsxæˆ–xlsæ ¼å¼çš„æ–‡ä»¶ï¼');
                return;
            }
            console.log('âœ“ æ–‡ä»¶æ ¼å¼éªŒè¯é€šè¿‡ï¼š', fileExtension);

            uploadedInvestmentFile = file;

            try {
                // è§£æExcelæ–‡ä»¶
                console.log('ğŸ”„ å¼€å§‹è§£æExcelæ–‡ä»¶...');
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];

                // ä½¿ç”¨header:1é€‰é¡¹å°†æ•°æ®è§£æä¸ºäºŒç»´æ•°ç»„ï¼Œé¿å…SheetJSè‡ªåŠ¨è¯†åˆ«æ ‡é¢˜è¡Œçš„é—®é¢˜
                const arrayData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                console.log('âœ“ Excelæ–‡ä»¶è§£ææˆåŠŸï¼Œå…±', arrayData.length, 'è¡Œæ•°æ®');

                // æ£€æŸ¥æ•°æ®è¡Œæ•°
                if (arrayData.length < 2) {
                    console.error('âŒ æ–‡ä»¶æ•°æ®ä¸è¶³ï¼Œè‡³å°‘éœ€è¦åŒ…å«æ ‡é¢˜è¡Œå’Œä¸€è¡Œæ•°æ®');
                    alert('æ–‡ä»¶æ•°æ®ä¸è¶³ï¼è¯·ç¡®ä¿æ–‡ä»¶åŒ…å«æ ‡é¢˜è¡Œå’Œè‡³å°‘ä¸€è¡Œæ•°æ®ã€‚\n\næ ¼å¼è¦æ±‚ï¼š\n- ç¬¬ä¸€åˆ—ï¼š18ä½é¡¹ç›®ä»£ç \n- ç¬¬äºŒåˆ—ï¼šæœ¬æœˆæ–°å¢å»ºå®‰\n- ç¬¬ä¸‰åˆ—ï¼šæœ¬æœˆæ–°å¢è®¾å¤‡å·¥å™¨å…·\n- ç¬¬å››åˆ—ï¼šæœ¬æœˆæ–°å¢å…¶ä»–\n- ç¬¬ä¸€è¡Œä¸ºæ ‡é¢˜è¡Œ');
                    return;
                }

                // æ¸…ç©ºä¹‹å‰çš„æ•°æ®
                investmentData.clear();

                // æå–é¡¹ç›®ä»£ç å’Œä¸‰ä¸ªæŠ•èµ„é¢æŒ‡æ ‡
                console.log('ğŸ“Š [æŠ•èµ„é¢ä¸Šä¼ ] å¼€å§‹æå–é¡¹ç›®ä»£ç å’ŒæŠ•èµ„é¢æŒ‡æ ‡...');
                let validCount = 0;
                let invalidCount = 0;

                arrayData.forEach((row, index) => {
                    // è·³è¿‡æ ‡é¢˜è¡Œ
                    if (index === 0) {
                        console.log('ğŸ“‹ [æŠ•èµ„é¢ä¸Šä¼ ] è·³è¿‡æ ‡é¢˜è¡Œï¼š', JSON.stringify(row));
                        return;
                    }

                    // è·å–å››åˆ—æ•°æ®ï¼šé¡¹ç›®ä»£ç ã€æœ¬æœˆæ–°å¢å»ºå®‰ã€æœ¬æœˆæ–°å¢è®¾å¤‡å·¥å™¨å…·ã€æœ¬æœˆæ–°å¢å…¶ä»–
                    // å…è®¸æŸäº›åˆ—ä¸ºç©ºï¼Œå°†åœ¨åç»­å¤„ç†ä¸­è½¬æ¢ä¸º0
                    const projectCode = row[0]?.toString().trim();
                    const jiananStr = row[1];
                    const shebeiStr = row[2];
                    const qitaStr = row[3];

                    const jianan = parseFloat(jiananStr);
                    const shebei = parseFloat(shebeiStr);
                    const qita = parseFloat(qitaStr);

                    // éªŒè¯é¡¹ç›®ä»£ç 
                    if (!projectCode) {
                        invalidCount++;
                        console.warn(`âš ï¸ [æŠ•èµ„é¢ä¸Šä¼ ] ç¬¬${index + 1}è¡Œé¡¹ç›®ä»£ç ä¸ºç©ºï¼š`, JSON.stringify(row));
                        return;
                    }

                    if (projectCode.length !== 18) {
                        invalidCount++;
                        console.warn(`âš ï¸ [æŠ•èµ„é¢ä¸Šä¼ ] ç¬¬${index + 1}è¡Œé¡¹ç›®ä»£ç é•¿åº¦é”™è¯¯ï¼ˆåº”ä¸º18ä½ï¼‰ï¼š${projectCode}`);
                        return;
                    }

                    // éªŒè¯ä¸‰ä¸ªæŠ•èµ„é¢æŒ‡æ ‡ï¼ˆå…è®¸ä¸ºç©ºï¼Œä¸ºç©ºæ—¶è§†ä¸º0ï¼‰
                    const validJianan = isNaN(jianan) ? 0 : jianan;
                    const validShebei = isNaN(shebei) ? 0 : shebei;
                    const validQita = isNaN(qita) ? 0 : qita;

                    // æ•°æ®æœ‰æ•ˆï¼Œæ·»åŠ åˆ°æ˜ å°„
                    investmentData.set(projectCode, {
                        jianan: validJianan,
                        shebei: validShebei,
                        qita: validQita
                    });
                    validCount++;
                    console.log(`âœ… [æŠ•èµ„é¢ä¸Šä¼ ] ç¬¬${index + 1}è¡Œï¼šé¡¹ç›®ä»£ç =${projectCode}, å»ºå®‰=${validJianan}ä¸‡å…ƒ, è®¾å¤‡=${validShebei}ä¸‡å…ƒ, å…¶ä»–=${validQita}ä¸‡å…ƒ`);
                });

                console.log(`ğŸ“ˆ [æŠ•èµ„é¢ä¸Šä¼ ] æ•°æ®æå–å®Œæˆï¼šæœ‰æ•ˆæ•°æ® ${validCount} æ¡ï¼Œæ— æ•ˆæ•°æ® ${invalidCount} æ¡`);

                // æ£€æŸ¥æœ‰æ•ˆæ•°æ®æ•°é‡
                if (validCount === 0) {
                    console.error('âŒ [æŠ•èµ„é¢ä¸Šä¼ ] æœªæå–åˆ°æœ‰æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®');
                    alert('æœªæå–åˆ°æœ‰æ•ˆæ•°æ®ï¼è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼š\n\n1. æ–‡ä»¶æ ¼å¼ï¼š.xlsx æˆ– .xls\n2. ç¬¬ä¸€åˆ—ï¼š18ä½é¡¹ç›®ä»£ç \n3. ç¬¬äºŒåˆ—ï¼šæœ¬æœˆæ–°å¢å»ºå®‰\n4. ç¬¬ä¸‰åˆ—ï¼šæœ¬æœˆæ–°å¢è®¾å¤‡å·¥å™¨å…·\n5. ç¬¬å››åˆ—ï¼šæœ¬æœˆæ–°å¢å…¶ä»–\n6. ç¬¬ä¸€è¡Œä¸ºæ ‡é¢˜è¡Œ\n\nç¤ºä¾‹ï¼š\né¡¹ç›®ä»£ç             æœ¬æœˆæ–°å¢å»ºå®‰  æœ¬æœˆæ–°å¢è®¾å¤‡å·¥å™¨å…·  æœ¬æœˆæ–°å¢å…¶ä»–\nMA4F0WYH0420582003  5000        2000              1000');
                    return;
                }

                console.log('ğŸ—„ï¸ [æŠ•èµ„é¢ä¸Šä¼ ] æœ€ç»ˆæŠ•èµ„æ•°æ®ï¼š', Object.fromEntries(investmentData));

                updateStatus(`å·²ä¸Šä¼ æŠ•èµ„é¢æ–‡ä»¶ï¼Œè§£æåˆ° ${investmentData.size} ä¸ªé¡¹ç›®ï¼ˆæœ‰æ•ˆï¼š${validCount}æ¡ï¼Œæ— æ•ˆï¼š${invalidCount}æ¡ï¼‰`);

                // å¯ç”¨ç­›é€‰æŒ‰é’®ï¼ˆè°ƒç”¨æ›´æ–°å‡½æ•°ï¼‰
                updateFilterButtonStatus();
                const filterBtn = document.getElementById('filterFiles');
                console.log('ğŸ”˜ [æŠ•èµ„é¢ä¸Šä¼ ] ç­›é€‰æŒ‰é’®çŠ¶æ€ï¼š', filterBtn.disabled ? 'ç¦ç”¨' : 'å¯ç”¨');

                console.log('ğŸ“‹ [æŠ•èµ„é¢ä¸Šä¼ ] === æŠ•èµ„é¢æ–‡ä»¶ä¸Šä¼ å®Œæˆ ===');
            } catch (error) {
                console.error('âŒ [æŠ•èµ„é¢ä¸Šä¼ ] è§£ææŠ•èµ„é¢æ–‡ä»¶é”™è¯¯ï¼š', error);
                updateStatus(`è§£ææŠ•èµ„é¢æ–‡ä»¶é”™è¯¯ï¼š${error.message}`);
                alert('è§£ææ–‡ä»¶å¤±è´¥ï¼š' + error.message + '\n\nè¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®ï¼š\n1. æ–‡ä»¶æ ¼å¼ï¼š.xlsx æˆ– .xls\n2. ç¬¬ä¸€åˆ—ï¼š18ä½é¡¹ç›®ä»£ç \n3. ç¬¬äºŒåˆ—ï¼šæœ¬æœˆæ–°å¢å»ºå®‰\n4. ç¬¬ä¸‰åˆ—ï¼šæœ¬æœˆæ–°å¢è®¾å¤‡å·¥å™¨å…·\n5. ç¬¬å››åˆ—ï¼šæœ¬æœˆæ–°å¢å…¶ä»–\n6. ç¬¬ä¸€è¡Œä¸ºæ ‡é¢˜è¡Œ');
            }
        });

        // è¾“å…¥æ¡†äº‹ä»¶å¤„ç†
        function updateFilterButtonStatus() {
            const investmentValue = document.getElementById('investmentValue').value;
            const filterBtn = document.getElementById('filterFiles');

            // æ£€æŸ¥æ•°å€¼æ˜¯å¦å·²è¾“å…¥ï¼Œä¸”æŠ•èµ„æ•°æ®å·²åŠ è½½
            filterBtn.disabled = !investmentValue || investmentData.size === 0;

            // æ›´æ–°ç”Ÿæˆåˆ—è¡¨æŒ‰é’®çŠ¶æ€
            updateRegenerateButtonStatus();
        }

        // ä¸ºè¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('investmentValue').addEventListener('input', updateFilterButtonStatus);

        // æ·»åŠ ç”Ÿæˆåˆ—è¡¨æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('regenerateList').addEventListener('click', regenerateProjectList);

        // æ·»åŠ ç”Ÿæˆè§£é”å…¬å¼æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('generateUnlockFormula').addEventListener('click', async () => {
            console.log('ğŸ“‹ [è§£é”å…¬å¼] === å¼€å§‹ç”Ÿæˆè§£é”å…¬å¼ ===');

            if (investmentData.size === 0) {
                console.warn('âš  [è§£é”å…¬å¼] æœªä¸Šä¼ æŠ•èµ„é¢æ–‡ä»¶æˆ–æœªè§£æåˆ°æ•°æ®');
                alert('è¯·å…ˆä¸Šä¼ æŠ•èµ„é¢æ–‡ä»¶ï¼');
                return;
            }

            // ç”Ÿæˆè§£é”å…¬å¼æ•°æ®
            const unlockFormulaData = [];
            unlockFormulaData.push(['é¡¹ç›®ä»£ç ', 'è§£é”å…¬å¼']);

            investmentData.forEach((data, projectCode) => {
                const { jianan, shebei, qita } = data;
                const total = jianan + shebei + qita;

                // ç”Ÿæˆè§£é”å…¬å¼
                const unlockItems = [];
                if (total >= 10000) unlockItems.push('B42001');
                if (jianan >= 5000) unlockItems.push('B42002');
                if (shebei >= 5000) unlockItems.push('B42003');
                if (qita >= 5000) unlockItems.push('B42004');

                const formula = unlockItems.join('ã€');

                // åªæœ‰å½“å…¬å¼ä¸ä¸ºç©ºæ—¶æ‰æ·»åŠ åˆ°ç»“æœä¸­
                if (formula) {
                    unlockFormulaData.push([projectCode, formula]);
                    console.log(`âœ… [è§£é”å…¬å¼] é¡¹ç›® ${projectCode} ç”Ÿæˆå…¬å¼ï¼š${formula}`);
                } else {
                    console.log(`â­ï¸ [è§£é”å…¬å¼] é¡¹ç›® ${projectCode} æœªç”Ÿæˆå…¬å¼ï¼Œè·³è¿‡`);
                }
            });

            console.log('ğŸ“Š [è§£é”å…¬å¼] ç”Ÿæˆè§£é”å…¬å¼æ•°æ®ï¼š', unlockFormulaData);

            // ç”ŸæˆExcelæ–‡ä»¶
            const ws = XLSX.utils.aoa_to_sheet(unlockFormulaData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'è§£é”å…¬å¼');

            // ä¸‹è½½Excelæ–‡ä»¶
            const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'è§£é”å…¬å¼.xlsx';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            console.log('âœ… [è§£é”å…¬å¼] è§£é”å…¬å¼ç”Ÿæˆå®Œæˆ');
        });

        // æ›´æ–°ç”Ÿæˆè§£é”å…¬å¼æŒ‰é’®çŠ¶æ€
        function updateGenerateUnlockFormulaButtonStatus() {
            const generateBtn = document.getElementById('generateUnlockFormula');
            generateBtn.disabled = investmentData.size === 0;
        }

        // ä¿®æ”¹updateFilterButtonStatuså‡½æ•°ï¼ŒåŒæ—¶æ›´æ–°ç”Ÿæˆè§£é”å…¬å¼æŒ‰é’®çŠ¶æ€
        const originalUpdateFilterButtonStatus = updateFilterButtonStatus;
        updateFilterButtonStatus = function () {
            originalUpdateFilterButtonStatus();
            updateGenerateUnlockFormulaButtonStatus();
        };

        // æ›´æ–°ç”Ÿæˆåˆ—è¡¨æŒ‰é’®çŠ¶æ€
        function updateRegenerateButtonStatus() {
            const regenerateBtn = document.getElementById('regenerateList');
            // åªè¦é€‰æ‹©äº†ç›®å½•ä¸”è¾“å‡ºæ–‡ä»¶å¤¹å­˜åœ¨ï¼Œå°±å¯ä»¥ç”Ÿæˆåˆ—è¡¨
            regenerateBtn.disabled = !rootDirectoryHandle;
        }

        // é€’å½’éå†ç›®å½•ï¼Œå¯»æ‰¾æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶
        async function searchFiles(directoryHandle, currentPath) {
            const files = [];

            for await (const entry of directoryHandle.values()) {
                // å¿½ç•¥è¾“å‡ºæ–‡ä»¶å¤¹
                if (entry.name === 'è¾“å‡º') {
                    console.log(`â­ï¸ è·³è¿‡è¾“å‡ºæ–‡ä»¶å¤¹ï¼š${currentPath}/${entry.name}`);
                    continue;
                }

                const fullPath = currentPath ? `${currentPath}/${entry.name}` : entry.name;

                if (entry.kind === 'directory') {
                    // é€’å½’å¤„ç†å­ç›®å½•
                    const subFiles = await searchFiles(entry, fullPath);
                    files.push(...subFiles);
                } else if (entry.kind === 'file') {
                    const fileName = entry.name.toLowerCase();
                    if (fileName.endsWith('.docx') || fileName.endsWith('.doc') || fileName.endsWith('.wps')) {
                        files.push({
                            handle: entry,
                            name: entry.name,
                            path: fullPath
                        });
                        console.log(`ğŸ“„ æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶ï¼š${fullPath}`);
                    }
                }
            }

            return files;
        }

        // ç”Ÿæˆé¡¹ç›®æ–‡ä»¶åˆ—è¡¨å‡½æ•°
        async function regenerateProjectList() {
            console.log('ğŸ“‹ [ç”Ÿæˆåˆ—è¡¨] === å¼€å§‹ç”Ÿæˆé¡¹ç›®æ–‡ä»¶åˆ—è¡¨ ===');

            if (!rootDirectoryHandle) {
                console.error('âŒ [ç”Ÿæˆåˆ—è¡¨] æœªé€‰æ‹©ç›®å½•ï¼Œæ— æ³•ç”Ÿæˆåˆ—è¡¨');
                updateStatus('è¯·å…ˆé€‰æ‹©ç›®å½•ï¼');
                return;
            }

            try {
                // é€’å½’è¯»å–æ ¹ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼Œå¿½ç•¥è¾“å‡ºæ–‡ä»¶å¤¹
                console.log('ğŸ” [ç”Ÿæˆåˆ—è¡¨] é€’å½’è¯»å–æ ¹ç›®å½•ä¸­çš„æ–‡ä»¶...');
                const allFiles = await searchFiles(rootDirectoryHandle, '');
                console.log(`ğŸ“Š [ç”Ÿæˆåˆ—è¡¨] å…±æ‰¾åˆ° ${allFiles.length} ä¸ªç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶`);

                if (allFiles.length === 0) {
                    console.warn('âš  [ç”Ÿæˆåˆ—è¡¨] æ ¹ç›®å½•ä¸­æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶');
                    updateStatus('æ ¹ç›®å½•ä¸­æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶ï¼');
                    return;
                }

                updateStatus('å¼€å§‹ç”Ÿæˆé¡¹ç›®æ–‡ä»¶åˆ—è¡¨...');

                // å‡†å¤‡Excelæ•°æ®ï¼ŒåŒ…å«é¡¹ç›®ä»£ç ã€é¡¹ç›®åå’Œæ–‡ä»¶è·¯å¾„ï¼ˆä¸å«æ–‡ä»¶åï¼‰
                const excelData = [];
                excelData.push(['é¡¹ç›®ä»£ç ', 'é¡¹ç›®å', 'åŸæ–‡ä»¶ä½ç½®']);
                console.log('ğŸ“‹ [ç”Ÿæˆåˆ—è¡¨] åˆå§‹åŒ–Excelæ•°æ®ï¼Œæ·»åŠ è¡¨å¤´');

                // è§£ææ¯ä¸ªæ–‡ä»¶ï¼Œæå–é¡¹ç›®ä»£ç ã€é¡¹ç›®åç§°å’Œæ–‡ä»¶è·¯å¾„
                for (const fileInfo of allFiles) {
                    const { name, path } = fileInfo;
                    const nameWithoutExt = name.substring(0, name.lastIndexOf('.'));
                    const projectCode = nameWithoutExt.substring(0, 18);
                    const projectName = nameWithoutExt.substring(18);

                    // æå–æ–‡ä»¶è·¯å¾„ï¼ˆä¸å«æ–‡ä»¶åï¼‰
                    const filePath = path.substring(0, path.lastIndexOf('/')) || '';

                    console.log(`ğŸ“„ [ç”Ÿæˆåˆ—è¡¨] è§£ææ–‡ä»¶ï¼š${path}`);
                    console.log(`   [ç”Ÿæˆåˆ—è¡¨] é¡¹ç›®ä»£ç ï¼š${projectCode}`);
                    console.log(`   [ç”Ÿæˆåˆ—è¡¨] é¡¹ç›®åç§°ï¼š${projectName}`);
                    console.log(`   [ç”Ÿæˆåˆ—è¡¨] æ–‡ä»¶è·¯å¾„ï¼š${filePath}`);

                    // æ·»åŠ åˆ°Excelæ•°æ®ï¼ŒåŒ…å«é¡¹ç›®ä»£ç ã€é¡¹ç›®åå’Œæ–‡ä»¶è·¯å¾„ï¼ˆä¸å«æ–‡ä»¶åï¼‰
                    excelData.push([projectCode, projectName, filePath]);
                }

                // ç”ŸæˆExcelæ–‡ä»¶
                console.log('ğŸ“ˆ å¼€å§‹ç”ŸæˆExcelæ–‡ä»¶...');
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'é¡¹ç›®æ–‡ä»¶åˆ—è¡¨');
                console.log('âœ“ Excelå·¥ä½œè¡¨åˆ›å»ºå®Œæˆï¼ŒåŒ…å«', excelData.length, 'è¡Œæ•°æ®');

                // ç”ŸæˆExcelæ–‡ä»¶çš„äºŒè¿›åˆ¶æ•°æ®
                const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                const excelBlob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                console.log('âœ“ Excelæ–‡ä»¶äºŒè¿›åˆ¶æ•°æ®ç”Ÿæˆå®Œæˆï¼Œå¤§å°ï¼š', excelBlob.size, 'å­—èŠ‚');

                // é€šè¿‡æµè§ˆå™¨ä¸‹è½½Excelæ–‡ä»¶
                console.log('ğŸ“¤ [ç”Ÿæˆåˆ—è¡¨] å¼€å§‹ä¸‹è½½Excelæ–‡ä»¶...');
                const url = URL.createObjectURL(excelBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'é¡¹ç›®æ–‡ä»¶åˆ—è¡¨.xlsx';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                console.log('âœ… [ç”Ÿæˆåˆ—è¡¨] Excelæ–‡ä»¶ä¸‹è½½å®Œæˆï¼šé¡¹ç›®æ–‡ä»¶åˆ—è¡¨.xlsx');

                updateStatus(`<span style="color: #48bb78;">ç”Ÿæˆåˆ—è¡¨å®Œæˆï¼</span> å…±å¤„ç† ${allFiles.length} ä¸ªæ–‡ä»¶ï¼Œå·²ç”Ÿæˆå¹¶ä¸‹è½½Excelæ–‡ä»¶`);
                console.log(`ğŸ‰ [ç”Ÿæˆåˆ—è¡¨] ç”Ÿæˆåˆ—è¡¨å®Œæˆï¼å…±å¤„ç† ${allFiles.length} ä¸ªæ–‡ä»¶`);

            } catch (error) {
                console.error('âŒ ç”Ÿæˆåˆ—è¡¨é”™è¯¯ï¼š', error);
                let errorMessage = `ç”Ÿæˆåˆ—è¡¨é”™è¯¯ï¼š${error.message}`;
                let solutions = '<br><br>è§£å†³æ–¹æ¡ˆï¼š<br>1. è¯·ç¡®ä¿"è¾“å‡º"æ–‡ä»¶å¤¹å·²å­˜åœ¨<br>2. è¯·ç¡®ä¿æ‚¨æœ‰æƒé™å†™å…¥è¯¥ç›®å½•<br>3. è¯·ç¡®ä¿ç›®å½•æœªè¢«å…¶ä»–ç¨‹åºå ç”¨';

                if (error.name === 'NotFoundError') {
                    errorMessage = '<span style="color: #f56565;">ç”Ÿæˆåˆ—è¡¨é”™è¯¯ï¼šæœªæ‰¾åˆ°"è¾“å‡º"æ–‡ä»¶å¤¹</span>';
                    solutions = '<br><br>è§£å†³æ–¹æ¡ˆï¼š<br>1. è¯·å…ˆé€‰æ‹©ç›®å½•å¹¶å¤„ç†æ–‡ä»¶ï¼Œç”Ÿæˆ"è¾“å‡º"æ–‡ä»¶å¤¹<br>2. ç¡®ä¿æ‚¨å·²å®Œæˆæ–‡ä»¶å¤„ç†æ­¥éª¤';
                }

                updateStatus(errorMessage + solutions);
                alert('ç”Ÿæˆåˆ—è¡¨å¤±è´¥ï¼š' + error.message);
            }
        }

        document.getElementById('selectDir').addEventListener('click', async () => {
            try {
                console.log('=== å¼€å§‹é€‰æ‹©ç›®å½• ===');
                const handle = await window.showDirectoryPicker();
                rootDirectoryHandle = handle;
                selectedDirectory = handle.name;
                selectedFiles = [];
                console.log('âœ“ æˆåŠŸé€‰æ‹©ç›®å½•ï¼š', selectedDirectory);

                await processDirectory(handle, '');
                console.log('âœ“ æ–‡ä»¶æ‰«æå®Œæˆï¼Œæ‰¾åˆ°', selectedFiles.length, 'ä¸ªç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶');
                console.log('ğŸ“‹ æ‰¾åˆ°çš„æ–‡ä»¶åˆ—è¡¨ï¼š', selectedFiles.map(f => f.name));

                // æ£€æµ‹"è¾“å‡º"æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨
                try {
                    console.log('ğŸ” æ£€æµ‹"è¾“å‡º"æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨...');
                    await handle.getDirectoryHandle('è¾“å‡º');
                    console.log('âš  "è¾“å‡º"æ–‡ä»¶å¤¹å·²å­˜åœ¨');
                    // æ–‡ä»¶å¤¹å­˜åœ¨ï¼Œè¯¢é—®ç”¨æˆ·æ˜¯å¦åˆ é™¤
                    const confirmDelete = confirm('"è¾“å‡º"æ–‡ä»¶å¤¹å·²å­˜åœ¨ï¼Œæ˜¯å¦åˆ é™¤å¹¶é‡æ–°åˆ›å»ºï¼Ÿ');
                    if (confirmDelete) {
                        // åˆ é™¤ç°æœ‰æ–‡ä»¶å¤¹åŠå…¶å†…å®¹
                        console.log('ğŸ—‘ï¸ åˆ é™¤ç°æœ‰"è¾“å‡º"æ–‡ä»¶å¤¹...');
                        await handle.removeEntry('è¾“å‡º', { recursive: true });
                        console.log('âœ“ å·²åˆ é™¤æ—§çš„"è¾“å‡º"æ–‡ä»¶å¤¹');
                        updateStatus(`å·²åˆ é™¤æ—§çš„"è¾“å‡º"æ–‡ä»¶å¤¹ï¼Œå·²æ‰¾åˆ° ${selectedFiles.length} ä¸ªç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶`);
                    } else {
                        console.log('âš  ç”¨æˆ·å–æ¶ˆåˆ é™¤"è¾“å‡º"æ–‡ä»¶å¤¹');
                        updateStatus(`å·²æ‰¾åˆ° ${selectedFiles.length} ä¸ªç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶ï¼Œ"è¾“å‡º"æ–‡ä»¶å¤¹å·²å­˜åœ¨`);
                    }
                } catch (error) {
                    // æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œæ­£å¸¸æç¤º
                    console.log('âœ“ "è¾“å‡º"æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œå°†åœ¨å¤„ç†æ—¶åˆ›å»º');
                    updateStatus(`å·²æ‰¾åˆ° ${selectedFiles.length} ä¸ªç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶`);
                }

                displayFiles();
                document.getElementById('processFiles').disabled = selectedFiles.length === 0;
                // æ›´æ–°ç”Ÿæˆåˆ—è¡¨æŒ‰é’®çŠ¶æ€
                updateRegenerateButtonStatus();
                console.log('=== ç›®å½•é€‰æ‹©å’Œæ–‡ä»¶æ‰«æå®Œæˆ ===');
            } catch (error) {
                console.error('âŒ ç›®å½•é€‰æ‹©æˆ–æ–‡ä»¶æ‰«æé”™è¯¯ï¼š', error);
                updateStatus(`<span style="color: #f56565;">é”™è¯¯ï¼š${error.message}</span><br><br>è§£å†³æ–¹æ¡ˆï¼š<br>1. è¯·ç¡®ä¿æ‚¨æœ‰æƒé™è®¿é—®è¯¥ç›®å½•<br>2. è¯·ç¡®ä¿æµè§ˆå™¨æ”¯æŒæ–‡ä»¶ç³»ç»Ÿè®¿é—®API<br>3. å°è¯•é‡æ–°é€‰æ‹©ç›®å½•`);
            }
        });

        /**
         * é€’å½’å¤„ç†ç›®å½•ï¼ŒæŸ¥æ‰¾æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶
         * @param {FileSystemDirectoryHandle} directoryHandle - å½“å‰ç›®å½•å¥æŸ„
         * @param {string} currentPath - å½“å‰ç›®å½•çš„ç›¸å¯¹è·¯å¾„
         * @returns {Promise<void>} - æ— è¿”å›å€¼
         */
        async function processDirectory(directoryHandle, currentPath) {
            // éå†ç›®å½•ä¸­çš„æ‰€æœ‰æ¡ç›®
            for await (const entry of directoryHandle.values()) {
                // è·³è¿‡æ‰€æœ‰ä»¥"ç»“æ„"å¼€å¤´çš„æ–‡ä»¶å¤¹ï¼Œé¿å…é‡å¤å¤„ç†
                if (entry.name.startsWith('ç»“æ„')) {
                    continue;
                }

                // æ„å»ºå®Œæ•´çš„ç›¸å¯¹è·¯å¾„
                const fullPath = currentPath ? `${currentPath}/${entry.name}` : entry.name;

                // å¦‚æœæ˜¯å­ç›®å½•ï¼Œé€’å½’å¤„ç†
                if (entry.kind === 'directory') {
                    await processDirectory(entry, fullPath);
                }
                // å¦‚æœæ˜¯æ–‡ä»¶ï¼Œæ£€æŸ¥æ˜¯å¦ä¸ºç›®æ ‡æ–‡ä»¶ç±»å‹ï¼ˆ.docx, .doc, .wpsï¼‰
                else if (entry.kind === 'file') {
                    const fileName = entry.name.toLowerCase();
                    if (fileName.endsWith('.docx') || fileName.endsWith('.doc') || fileName.endsWith('.wps')) {
                        // æ·»åŠ åˆ°é€‰ä¸­æ–‡ä»¶åˆ—è¡¨
                        selectedFiles.push({
                            handle: entry,
                            name: entry.name,
                            path: fullPath
                        });
                    }
                }
            }
        }

        function displayFiles() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';

            if (selectedFiles.length === 0) {
                fileList.innerHTML = '<div class="file-item">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶</div>';
                return;
            }

            selectedFiles.forEach(file => {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.textContent = file.path;
                fileList.appendChild(div);
            });
        }

        /**
         * æ›´æ–°é¡µé¢çŠ¶æ€ä¿¡æ¯
         * @param {string} message - è¦æ˜¾ç¤ºçš„çŠ¶æ€ä¿¡æ¯ï¼Œå¯ä»¥åŒ…å«HTMLæ ‡ç­¾
         */
        function updateStatus(message) {
            const statusElement = document.getElementById('status');
            statusElement.innerHTML = `<strong>${message}</strong>`;
        }

        /**
         * ç­›é€‰æŒ‰é’®äº‹ä»¶å¤„ç†å‡½æ•°
         * åŠŸèƒ½ï¼šæŒ‰æŠ•èµ„é¢æ¡ä»¶ç­›é€‰æ–‡ä»¶ï¼Œå¹¶å°†ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶ç§»åŠ¨åˆ°ç›¸åº”çš„æ¡ä»¶æ–‡ä»¶å¤¹
         * ç­›é€‰é€»è¾‘ï¼š
         * 1. éªŒè¯è¾“å…¥çš„æŠ•èµ„é¢æ˜¯å¦æœ‰æ•ˆ
         * 2. æ£€æŸ¥æ¡ä»¶æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨
         * 3. è‹¥æ–‡ä»¶å¤¹å­˜åœ¨ï¼Œå°†å…¶å†…çš„æ‰€æœ‰æ–‡ä»¶ç§»åŠ¨åˆ°è¾“å‡ºæ–‡ä»¶å¤¹
         * 4. ç­›é€‰è¾“å‡ºæ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰æ–‡ä»¶
         * 5. å°†ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶ç§»åŠ¨åˆ°æ¡ä»¶æ–‡ä»¶å¤¹
         * 6. æ˜¾ç¤ºç­›é€‰ç»“æœ
         */
        document.getElementById('filterFiles').addEventListener('click', async () => {
            console.log('ğŸ“‹ [ç­›é€‰] === å¼€å§‹æŒ‰æŠ•èµ„é¢æ¡ä»¶ç­›é€‰æ–‡ä»¶ ===');
            if (selectedFiles.length === 0) {
                console.log('âš  [ç­›é€‰] æœªé€‰æ‹©æ–‡ä»¶ï¼Œæ— æ³•ç­›é€‰');
                updateStatus('è¯·å…ˆé€‰æ‹©ç›®å½•å¹¶å¤„ç†æ–‡ä»¶ï¼');
                return;
            }

            // è·å–è¾“å…¥å€¼
            const investmentValueStr = document.getElementById('investmentValue').value;

            // è½¬æ¢ä¸ºæ•°å€¼
            const investmentValue = parseFloat(investmentValueStr);

            // æ ¡éªŒè¾“å…¥æœ‰æ•ˆæ€§
            if (isNaN(investmentValue)) {
                console.error('âŒ æ— æ•ˆçš„æŠ•èµ„é¢ï¼š', investmentValue);
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æŠ•èµ„é¢ï¼');
                return;
            }

            // æ ¡éªŒæ•°å€¼ä¸ä¸ºè´Ÿæ•°
            if (investmentValue < 0) {
                console.error('âŒ æ— æ•ˆçš„æŠ•èµ„é¢ï¼šæŠ•èµ„é¢ä¸èƒ½ä¸ºè´Ÿæ•°', investmentValue);
                alert('æ— æ•ˆçš„æŠ•èµ„é¢ï¼æŠ•èµ„é¢ä¸èƒ½ä¸ºè´Ÿæ•°ã€‚');
                return;
            }

            console.log(`ğŸ¯ ç­›é€‰æ¡ä»¶ï¼šå¤§äºç­‰äº ${investmentValue}ä¸‡å…ƒ`);
            updateStatus('å¼€å§‹æŒ‰æŠ•èµ„é¢æ¡ä»¶ç­›é€‰æ–‡ä»¶...');

            // ç¦ç”¨ç­›é€‰æŒ‰é’®
            const filterBtn = document.getElementById('filterFiles');
            filterBtn.disabled = true;
            console.log('ğŸ”˜ ç­›é€‰æŒ‰é’®å·²ç¦ç”¨');

            try {
                // è·å–è¾“å‡ºæ–‡ä»¶å¤¹å¥æŸ„
                console.log('ğŸ“ è·å–è¾“å‡ºæ–‡ä»¶å¤¹å¥æŸ„...');
                let outputDirHandle;
                try {
                    outputDirHandle = await rootDirectoryHandle.getDirectoryHandle('è¾“å‡º');
                    console.log('âœ“ æˆåŠŸè·å–è¾“å‡ºæ–‡ä»¶å¤¹å¥æŸ„');
                } catch (error) {
                    console.error('âŒ æœªæ‰¾åˆ°"è¾“å‡º"æ–‡ä»¶å¤¹ï¼š', error);
                    alert('ç­›é€‰å¤±è´¥ï¼šæœªæ‰¾åˆ°"è¾“å‡º"æ–‡ä»¶å¤¹ï¼\n\nè¯·å…ˆé€‰æ‹©ç›®å½•å¹¶å¤„ç†æ–‡ä»¶ï¼Œç”Ÿæˆ"è¾“å‡º"æ–‡ä»¶å¤¹åå†è¿›è¡Œç­›é€‰æ“ä½œã€‚');
                    updateStatus('ç­›é€‰å¤±è´¥ï¼šæœªæ‰¾åˆ°"è¾“å‡º"æ–‡ä»¶å¤¹');
                    filterBtn.disabled = false;
                    return;
                }

                // ç”Ÿæˆæ¡ä»¶æ–‡ä»¶å¤¹åç§°ï¼Œå›ºå®šä¸ºå¤§äºç­‰äº
                let folderName = `ç»“æ„è¶…${investmentValue}`;

                let conditionFolderHandle;
                console.log(`ğŸ“ å‡†å¤‡åœ¨è¾“å‡ºæ–‡ä»¶å¤¹å†…åˆ›å»ºæ¡ä»¶æ–‡ä»¶å¤¹ï¼š${folderName}`);

                // æ£€æµ‹æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨
                try {
                    console.log(`ğŸ” æ£€æµ‹è¾“å‡ºæ–‡ä»¶å¤¹å†…"${folderName}"æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨...`);
                    conditionFolderHandle = await outputDirHandle.getDirectoryHandle(folderName);
                    console.log(`âš  è¾“å‡ºæ–‡ä»¶å¤¹å†…"${folderName}"æ–‡ä»¶å¤¹å·²å­˜åœ¨`);

                    // æ–‡ä»¶å¤¹å­˜åœ¨ï¼Œå°†å…¶å†…çš„æ‰€æœ‰æ–‡ä»¶ç§»åŠ¨åˆ°ä¸Šä¸€çº§æ–‡ä»¶å¤¹ï¼ˆè¾“å‡ºæ–‡ä»¶å¤¹ï¼‰
                    console.log(`ğŸ“¤ å¼€å§‹å°†"${folderName}"æ–‡ä»¶å¤¹å†…çš„æ–‡ä»¶ç§»åŠ¨åˆ°è¾“å‡ºæ–‡ä»¶å¤¹...`);
                    let movedFileCount = 0;

                    // éå†æ¡ä»¶æ–‡ä»¶å¤¹å†…çš„æ‰€æœ‰æ–‡ä»¶
                    for await (const entry of conditionFolderHandle.values()) {
                        if (entry.kind === 'file') {
                            try {
                                // è·å–æºæ–‡ä»¶å¥æŸ„
                                const sourceFileHandle = await conditionFolderHandle.getFileHandle(entry.name);
                                // åœ¨è¾“å‡ºæ–‡ä»¶å¤¹ä¸­åˆ›å»ºç›®æ ‡æ–‡ä»¶
                                const destFileHandle = await outputDirHandle.getFileHandle(entry.name, { create: true });
                                // è·å–å¯å†™æµå¹¶å†™å…¥æ–‡ä»¶
                                const sourceFile = await sourceFileHandle.getFile();
                                const destWritable = await destFileHandle.createWritable();
                                await destWritable.write(await sourceFile.arrayBuffer());
                                await destWritable.close();
                                // åˆ é™¤æºæ–‡ä»¶
                                await conditionFolderHandle.removeEntry(entry.name);
                                movedFileCount++;
                                console.log(`ğŸ“„ å·²å°†"${entry.name}"ä»"${folderName}"ç§»åŠ¨åˆ°è¾“å‡ºæ–‡ä»¶å¤¹`);
                            } catch (error) {
                                console.error(`âŒ ç§»åŠ¨æ–‡ä»¶"${entry.name}"å¤±è´¥ï¼š`, error);
                            }
                        }
                    }

                    console.log(`âœ“ å…±å°†${movedFileCount}ä¸ªæ–‡ä»¶ä»"${folderName}"ç§»åŠ¨åˆ°è¾“å‡ºæ–‡ä»¶å¤¹`);

                } catch (error) {
                    // æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œç›´æ¥åˆ›å»º
                    console.log(`ğŸ“ è¾“å‡ºæ–‡ä»¶å¤¹å†…"${folderName}"æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œç›´æ¥åˆ›å»º...`);
                    conditionFolderHandle = await outputDirHandle.getDirectoryHandle(folderName, { create: true });
                    console.log(`âœ“ æˆåŠŸåˆ›å»º"${folderName}"æ–‡ä»¶å¤¹`);
                }

                // è·å–è¾“å‡ºæ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰æ–‡ä»¶
                console.log('ğŸ“‹ è¯»å–è¾“å‡ºæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶...');
                const outputFiles = [];
                for await (const entry of outputDirHandle.values()) {
                    if (entry.kind === 'directory') {
                        // è·³è¿‡æ‰€æœ‰ä»¥"ç»“æ„"å¼€å¤´çš„æ–‡ä»¶å¤¹ï¼ˆåŒ…æ‹¬ç»“æ„è¶…ã€ç»“æ„[ã€ç»“æ„(ç­‰ï¼‰
                        if (entry.name.startsWith('ç»“æ„')) {
                            console.log(`â­ï¸ è·³è¿‡è¾“å‡ºæ–‡ä»¶å¤¹å†…çš„"${entry.name}"æ–‡ä»¶å¤¹`);
                            continue;
                        }
                    } else if (entry.kind === 'file') {
                        // åªå¤„ç†docxã€docã€wpsæ–‡ä»¶
                        const fileName = entry.name.toLowerCase();
                        if (fileName.endsWith('.docx') || fileName.endsWith('.doc') || fileName.endsWith('.wps')) {
                            outputFiles.push(entry);
                            console.log(`ğŸ“„ æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶ï¼š${entry.name}`);
                        } else {
                            console.log(`â­ï¸ è·³è¿‡éç›®æ ‡æ–‡ä»¶ï¼š${entry.name}`);
                        }
                    }
                }
                console.log(`ğŸ“Š å…±æ‰¾åˆ° ${outputFiles.length} ä¸ªæ–‡ä»¶å¾…ç­›é€‰`);

                // ç­›é€‰å¹¶ç§»åŠ¨æ–‡ä»¶
                console.log('ğŸ”„ å¼€å§‹ç­›é€‰å¹¶ç§»åŠ¨æ–‡ä»¶...');
                let movedCount = 0;
                for (const fileHandle of outputFiles) {
                    // è§£ææ–‡ä»¶åï¼Œè·å–é¡¹ç›®ä»£ç 
                    const fileName = fileHandle.name;
                    const nameWithoutExt = fileName.substring(0, fileName.lastIndexOf('.'));
                    const projectCode = nameWithoutExt.substring(0, 18);
                    console.log(`ğŸ” è§£ææ–‡ä»¶ï¼š${fileName}`);
                    console.log(`   é¡¹ç›®ä»£ç ï¼š${projectCode}`);

                    // æŸ¥æ‰¾æŠ•èµ„é¢æ•°æ®ï¼ˆåŒ…å«ä¸‰ä¸ªæŒ‡æ ‡ï¼‰
                    const investmentDataItem = investmentData.get(projectCode);
                    if (!investmentDataItem) {
                        console.log(`   æœªæ‰¾åˆ°å¯¹åº”æŠ•èµ„é¢æ•°æ®ï¼Œè·³è¿‡æ–‡ä»¶`);
                        continue;
                    }

                    console.log(`   å¯¹åº”æŠ•èµ„é¢æ•°æ®ï¼šå»ºå®‰=${investmentDataItem.jianan}ä¸‡å…ƒ, è®¾å¤‡=${investmentDataItem.shebei}ä¸‡å…ƒ, å…¶ä»–=${investmentDataItem.qita}ä¸‡å…ƒ`);

                    // åˆ¤æ–­ä¸‰ä¸ªæŒ‡æ ‡ä¸­çš„ä»»ä½•ä¸€ä¸ªæ˜¯å¦ç¬¦åˆæ¡ä»¶
                    let isMatch = false;

                    // å®šä¹‰æ¡ä»¶åˆ¤æ–­å‡½æ•°ï¼Œå›ºå®šä¸ºå¤§äºç­‰äº
                    const checkCondition = (value) => {
                        return value >= investmentValue;
                    };

                    // æ£€æŸ¥ä¸‰ä¸ªæŒ‡æ ‡ä¸­çš„ä»»ä½•ä¸€ä¸ªæ˜¯å¦ç¬¦åˆæ¡ä»¶
                    isMatch = checkCondition(investmentDataItem.jianan) ||
                        checkCondition(investmentDataItem.shebei) ||
                        checkCondition(investmentDataItem.qita);

                    console.log(`   æ¡ä»¶ç±»å‹ï¼šå¤§äºç­‰äº`);
                    console.log(`   æ¡ä»¶å€¼ï¼š${investmentValue}ä¸‡å…ƒ`);
                    console.log(`   æ˜¯å¦ç¬¦åˆæ¡ä»¶ï¼š${isMatch ? 'æ˜¯' : 'å¦'}`);

                    // å¦‚æœç¬¦åˆæ¡ä»¶ï¼Œåˆ™ç§»åŠ¨æ–‡ä»¶
                    if (isMatch) {
                        console.log(`âœ… ç¬¦åˆæ¡ä»¶ï¼Œç§»åŠ¨æ–‡ä»¶ï¼š${fileName} -> ${folderName}/${fileName}`);
                        // è¯»å–æºæ–‡ä»¶å†…å®¹
                        const sourceFile = await fileHandle.getFile();

                        // å†™å…¥åˆ°ç›®æ ‡æ–‡ä»¶å¤¹
                        const destinationFile = await conditionFolderHandle.getFileHandle(fileName, { create: true });
                        const writable = await destinationFile.createWritable();
                        await writable.write(await sourceFile.arrayBuffer());
                        await writable.close();

                        // åˆ é™¤æºæ–‡ä»¶ï¼ˆç§»åŠ¨æ“ä½œï¼‰
                        await outputDirHandle.removeEntry(fileName);
                        console.log(`âœ“ æ–‡ä»¶ç§»åŠ¨å®Œæˆï¼š${fileName}`);
                        movedCount++;
                    } else {
                        console.log(`â­ï¸ ä¸ç¬¦åˆæ¡ä»¶ï¼Œè·³è¿‡æ–‡ä»¶ï¼š${fileName}`);
                    }
                }
                console.log(`ğŸ‰ ç­›é€‰å®Œæˆï¼Œå…±ç§»åŠ¨ ${movedCount} ä¸ªæ–‡ä»¶`);

                // ç”Ÿæˆæ¡ä»¶æè¿°æ–‡æœ¬ï¼Œå›ºå®šä¸ºå¤§äºç­‰äº
                let conditionDescription = `å¤§äºç­‰äº ${investmentValue} ä¸‡å…ƒ`;

                updateStatus(`ç­›é€‰å®Œæˆï¼å…±ç­›é€‰å‡º <span style="color: #48bb78; font-weight: bold;">${movedCount}</span> ä¸ªæŒ‡æ ‡ç¬¦åˆæ¡ä»¶çš„é¡¹ç›®æ–‡ä»¶ï¼Œå·²ä»"è¾“å‡º"æ–‡ä»¶å¤¹å†…ç§»åŠ¨åˆ°"è¾“å‡º/${folderName}"æ–‡ä»¶å¤¹`);
                console.log('ğŸ’¬ æ˜¾ç¤ºç­›é€‰å®Œæˆæç¤ºä¿¡æ¯');

            } catch (error) {
                console.error('âŒ ç­›é€‰é”™è¯¯ï¼š', error);
                let errorMessage = `ç­›é€‰é”™è¯¯ï¼š${error.message}`;
                let solutions = '<br><br>è§£å†³æ–¹æ¡ˆï¼š<br>1. è¯·ç¡®ä¿"è¾“å‡º"æ–‡ä»¶å¤¹å·²å­˜åœ¨<br>2. è¯·ç¡®ä¿æ‚¨æœ‰æƒé™å†™å…¥è¯¥ç›®å½•<br>3. è¯·ç¡®ä¿ç›®å½•æœªè¢«å…¶ä»–ç¨‹åºå ç”¨<br>4. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¢«å…¶ä»–ç¨‹åºé”å®š';

                if (error.name === 'NotFoundError') {
                    errorMessage = '<span style="color: #f56565;">ç­›é€‰é”™è¯¯ï¼šæœªæ‰¾åˆ°"è¾“å‡º"æ–‡ä»¶å¤¹</span>';
                    solutions = '<br><br>è§£å†³æ–¹æ¡ˆï¼š<br>1. è¯·å…ˆé€‰æ‹©ç›®å½•å¹¶å¤„ç†æ–‡ä»¶ï¼Œç”Ÿæˆ"è¾“å‡º"æ–‡ä»¶å¤¹<br>2. ç¡®ä¿æ‚¨å·²å®Œæˆæ–‡ä»¶å¤„ç†æ­¥éª¤';
                }

                updateStatus(errorMessage + solutions);
                alert('ç­›é€‰å¤±è´¥ï¼š' + error.message);
            } finally {
                // å¯ç”¨ç­›é€‰æŒ‰é’®
                const filterBtn = document.getElementById('filterFiles');
                filterBtn.disabled = false;
                console.log('ğŸ”˜ ç­›é€‰æŒ‰é’®å·²å¯ç”¨');
                console.log('=== ç­›é€‰æµç¨‹ç»“æŸ ===');
            }
        });

        document.getElementById('processFiles').addEventListener('click', async () => {
            console.log('=== å¼€å§‹å¤åˆ¶æ–‡ä»¶ ===');
            if (selectedFiles.length === 0) {
                console.log('âš  æ²¡æœ‰æ–‡ä»¶éœ€è¦å¤åˆ¶');
                updateStatus('æ²¡æœ‰æ–‡ä»¶éœ€è¦å¤åˆ¶');
                return;
            }

            updateStatus('å¼€å§‹å¤åˆ¶æ–‡ä»¶...');

            // åªç¦ç”¨å¤åˆ¶æ–‡ä»¶æŒ‰é’®ï¼Œé¿å…é‡å¤ç‚¹å‡»
            const processFilesBtn = document.getElementById('processFiles');
            processFilesBtn.disabled = true;
            console.log('ğŸ”˜ å¤åˆ¶æ–‡ä»¶æŒ‰é’®å·²ç¦ç”¨');

            // æ˜¾ç¤ºè¿›åº¦æ¡
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            progressContainer.style.display = 'block';
            console.log('ğŸ“Š è¿›åº¦æ¡å·²æ˜¾ç¤º');

            try {
                // åˆ›å»º"è¾“å‡º"æ–‡ä»¶å¤¹
                console.log('ğŸ“ åˆ›å»º"è¾“å‡º"æ–‡ä»¶å¤¹...');
                const outputDirHandle = await rootDirectoryHandle.getDirectoryHandle('è¾“å‡º', { create: true });
                console.log('âœ“ æˆåŠŸåˆ›å»º"è¾“å‡º"æ–‡ä»¶å¤¹');

                // å¤„ç†æ¯ä¸ªæ–‡ä»¶
                const totalFiles = selectedFiles.length;
                console.log(`ğŸ“¦ å¼€å§‹å¤åˆ¶ ${totalFiles} ä¸ªæ–‡ä»¶...`);

                for (let i = 0; i < totalFiles; i++) {
                    const file = selectedFiles[i];

                    // æ›´æ–°è¿›åº¦
                    const progress = ((i + 1) / totalFiles) * 100;
                    const roundedProgress = Math.round(progress);
                    progressFill.style.width = `${progress}%`;
                    progressPercentage.textContent = `${roundedProgress}%`;
                    progressText.textContent = `å¤åˆ¶ä¸­ï¼š${i + 1}/${totalFiles}`;
                    console.log(`ğŸ”„ å¤åˆ¶è¿›åº¦ï¼š${roundedProgress}% (${i + 1}/${totalFiles})`);

                    // å¤åˆ¶æ–‡ä»¶åˆ°"è¾“å‡º"æ–‡ä»¶å¤¹
                    console.log(`ğŸ“‹ å¤åˆ¶æ–‡ä»¶ï¼š${file.name} -> è¾“å‡º/${file.name}`);
                    const sourceFile = await file.handle.getFile();
                    const destinationFile = await outputDirHandle.getFileHandle(file.name, { create: true });
                    const writable = await destinationFile.createWritable();
                    await writable.write(await sourceFile.arrayBuffer());
                    await writable.close();
                    console.log(`âœ“ æ–‡ä»¶å¤åˆ¶å®Œæˆï¼š${file.name}`);
                }

                updateStatus(`å¤åˆ¶å®Œæˆï¼å…±å¤åˆ¶ ${selectedFiles.length} ä¸ªæ–‡ä»¶åˆ°"è¾“å‡º"æ–‡ä»¶å¤¹`);
                console.log(`ğŸ‰ æ–‡ä»¶å¤åˆ¶å®Œæˆï¼å…±å¤åˆ¶ ${selectedFiles.length} ä¸ªæ–‡ä»¶`);

            } catch (error) {
                console.error('âŒ æ–‡ä»¶å¤åˆ¶é”™è¯¯ï¼š', error);
                updateStatus(`<span style="color: #f56565;">å¤åˆ¶é”™è¯¯ï¼š${error.message}</span><br><br>è§£å†³æ–¹æ¡ˆï¼š<br>1. è¯·ç¡®ä¿æ‚¨æœ‰æƒé™å†™å…¥è¯¥ç›®å½•<br>2. è¯·ç¡®ä¿ç›®å½•æœªè¢«å…¶ä»–ç¨‹åºå ç”¨<br>3. å°è¯•å…³é—­æµè§ˆå™¨å¹¶é‡æ–°æ‰“å¼€<br>4. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¢«å…¶ä»–ç¨‹åºé”å®š`);
                // é”™è¯¯æƒ…å†µä¸‹æ¢å¤å¤„ç†æ–‡ä»¶æŒ‰é’®çŠ¶æ€
                const processFilesBtn = document.getElementById('processFiles');
                processFilesBtn.disabled = false;
                console.log('ğŸ”˜ å¤åˆ¶æ–‡ä»¶æŒ‰é’®å·²å¯ç”¨ï¼ˆé”™è¯¯æ¢å¤ï¼‰');
            } finally {
                // æ¢å¤å¤„ç†æ–‡ä»¶æŒ‰é’®çŠ¶æ€
                const processFilesBtn = document.getElementById('processFiles');
                processFilesBtn.disabled = false;
                console.log('ğŸ”˜ å¤åˆ¶æ–‡ä»¶æŒ‰é’®å·²å¯ç”¨');
                // éšè—è¿›åº¦æ¡
                setTimeout(() => {
                    document.getElementById('progressContainer').style.display = 'none';
                    console.log('ğŸ“Š è¿›åº¦æ¡å·²éšè—');
                }, 1000);
                console.log('=== æ–‡ä»¶å¤åˆ¶æµç¨‹ç»“æŸ ===');
            }
        });
    </script>
    <footer
        style="text-align: center; padding: 20px; margin-top: 30px; color: #ffffff; font-size: 14px; border-top: 1px solid #e5e7eb;">
        <p>hanj-cn@qq.com \ v1.0 \ 20251226</p>
    </footer>
</body>

</html>